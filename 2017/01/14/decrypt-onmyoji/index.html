<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 阴阳师：一个非酋的逆向旅程 · fate0</title><meta name="description" content="阴阳师：一个非酋的逆向旅程 - fate0"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.fatezero.org/atom.xml" title="fate0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://www.fatezero.org" target="_blank" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">阴阳师：一个非酋的逆向旅程</h1><div class="post-info">Jan 14, 2017</div><div class="post-content"><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>为了验证这个游戏到底有没有 SSR</p>
<a id="more"></a>
<h2 id="0x01-前期工作"><a href="#0x01-前期工作" class="headerlink" title="0x01 前期工作"></a>0x01 前期工作</h2><p>直接将 <code>onmyoji_netease_1.0.14.apk</code> 解压出来观察各个文件，便可以知道阴阳师是使用 <code>NeoX + Python</code>。
其中 <code>lib/armeabi-v7a/libclient.so</code> 和 <code>assets/script.npk</code> 这两个文件，
一个是带着 Python 虚拟机以及加解密相关的 so 文件，一个是加密之后的 Python 文件，
所以我们后期的工作中心也主要放在这两个文件上。</p>
<p>为了能够在后面调试阴阳师，我们需要对阴阳师重打包：</p>
<ol>
<li><p>使用 <code>apktool</code> 解包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">apktool d onmyoji_netease_1.0.14.apk</div></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>debuggable</code><br>将 <code>AndroidManifest.xml</code> 中的 <code>debuggable</code> 修改为 <code>true</code></p>
</li>
<li><p>重打包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">apktool b onmyoji_netease_1.0.14</div></pre></td></tr></table></figure>
</li>
<li><p>签名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">java -jar signapk.jar platform.x509.pem platform.pk8 onmyoji_netease_1.0.14.apk onmyoji_netease_1.0.14_fix.apk</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="0x02-Android-调试初试"><a href="#0x02-Android-调试初试" class="headerlink" title="0x02 Android 调试初试"></a>0x02 Android 调试初试</h2><p>由于我是第一次进行 Android 调试，所以这里我写得稍微啰嗦一点儿。</p>
<ol>
<li><p>关闭SELinux</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">setenforce 0</div></pre></td></tr></table></figure>
</li>
<li><p>运行 android_server</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">/data/android_server</div></pre></td></tr></table></figure>
</li>
<li><p>将 android_server 的端口转发到本地</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">adb forward tcp:23946 tcp:23946</div></pre></td></tr></table></figure>
</li>
<li><p>启动阴阳师</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">am start -D -n  com.netease.onmyoji/com.netease.onmyoji.Launcher</div></pre></td></tr></table></figure>
</li>
<li><p>IDA 远程 Attach</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/ida_remote_attach.png">
</li>
<li><p>IDA 设置调试选项</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/ida_debug_option.png">
</li>
<li><p>将阴阳师的调试端口转发到本地</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">ps | grep netease.onmyoji</div><div class="line">adb forward tcp:17178 jdwp:process_pid</div></pre></td></tr></table></figure>
</li>
<li><p>jdb 附加</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=17178</div></pre></td></tr></table></figure>
</li>
</ol>
<p>由于种种原因，我需要重开很多次阴阳师，所以我就将步骤 7，8 合并成一个 <code>copy &amp; paste</code> 的命令
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">for /f &quot;delims=&quot; %i in (&apos;adb shell &quot;set `ps |grep netease.onmyoji`; echo -n $2&quot;&apos;) do adb forward tcp:17178 jdwp:%i &amp;&amp; jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=17178</div></pre></td></tr></table></figure></p>
<h2 id="0x03-格式分析"><a href="#0x03-格式分析" class="headerlink" title="0x03 格式分析"></a>0x03 格式分析</h2><p>在动态调试前，我们还是先看一下 <code>assets/script.npk</code> 的格式。虽然之前逆过网易其他游戏，也知道这文件是什么格式，
不过还是说一下我第一次分析的步骤，我们使用 C32 将其打开：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/script-format-1.png">
<p>除了一个 <code>NXPK</code> 的 header，也看不出其他信息，我们再看看文件的尾部：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/script-format-2.png">
<p>好像也没有什么特别的信息，不过等等，我们把窗口调整一下：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/script-format-3.png">
<p>现在就可以很清楚的看到数据中间有一排 <code>00000000</code>。我们可以大胆猜测有效数据是由 <code>00000000</code> 进行分割，
我们拿一小段数据出来分析：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">00000000 4C71C6FD ECD60A00 69040000 69040000 3057F779 3057F779</div><div class="line">00000000 A9B3CEFD 5CB91F00 AC000000 AC000000 80C1D70C 80C1D70C</div><div class="line">00000000 950CD6FD FC7E3500 C4050000 C4050000 21433D9E 21433D9E</div><div class="line">00000000 CA1EF8FD D88F2700 FE100000 FE100000 6BB047E4 6BB047E4</div><div class="line">00000000 73A33EFE 50614200 A71B0000 A71B0000 4A32F72E 4A32F72E</div><div class="line">00000000 A5E959FE C40B0300 0A090000 0A090000 9B7A1F45 9B7A1F45</div></pre></td></tr></table></figure>
<p>我们会发现：</p>
<ul>
<li>第四排和第五排数据重复，第六排和第七排数据重复，所以有效数据只有四排</li>
<li>第二排数据的尾部是由上至下递增的，但是第二排的数据已经大过了文件大小，暂时意义不明</li>
<li>第三排数据，存在和 <code>assets/script.npk</code> 文件大小相近的数据，但是不存在大于文件大小的数据，猜测第三排的数据和 <code>assets/script.npk</code> 文件的 <code>offset</code> 相关</li>
<li>再看看第四排的数据，第四排的数据都偏小，猜测第四排的数据和文件的 <code>大小</code> 相关</li>
<li>最后看第五排数据，暂时意义不明</li>
</ul>
<p>所以到这里我们可以猜测 <code>assets/script.npk</code> 的尾部数据是一个索引表，
阴阳师通过 Python 文件名计算出索引表的偏移量，然后再通过表格里面的文件偏移和大小，
获取到对应加密后的 Python 代码。</p>
<p>如果索引表真的存在，那么程序如何确定这个表的起始地址呢，我们找到这个索引表的前部：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/script-format-4.png">
<p>可以看到这个表格的起始地址为 <code>0x00522DE8</code>，我们在 C32 里面搜索这个地址：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/script-format-5.png">
<p>会发现文件起始地址偏移 0x14 处记录了索引表的地址。</p>
<p>总结: </p>
<ul>
<li><code>assets/script.npk</code> 在偏移量 0x14 处记录了索引表的地址</li>
<li>索引表每个索引由 <code>0x00000000</code> 进行分割</li>
<li>索引中的第三排数据是某个 Python 文件在 <code>assets/script.npk</code> 的偏移量</li>
<li>索引中的第四排数据是某个 Python 文件的大小</li>
</ul>
<h2 id="0x03-动态调试"><a href="#0x03-动态调试" class="headerlink" title="0x03 动态调试"></a>0x03 动态调试</h2><h4 id="read-amp-open"><a href="#read-amp-open" class="headerlink" title="read &amp; open"></a>read &amp; open</h4><p>在文章前面提过，<code>lib/armeabi-v7a/libclient.so</code> 和 <code>assets/script.npk</code> 这两个是重点文件，
在 <code>libclient.so</code> 加载之后，自然要关注一下 <code>script.npk</code>。</p>
<p>要想解密 <code>script.npk</code>，基本思路还是挺简单的：关注 <code>script.npk</code> 读取的数据经过了怎么样的处理。</p>
<p>为了更好的将 <code>read</code> 函数中的 fd 与文件名对应，我在 <code>open</code> 处下条件断点，并加上下面的判断：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> idc</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> hasattr(idc, <span class="string">"fd_map"</span>):</div><div class="line">    idc.fd_map = &#123;&#125;</div><div class="line"></div><div class="line">filename = GetString(cpu.r0)</div><div class="line"></div><div class="line"><span class="keyword">if</span> filename <span class="keyword">and</span> <span class="string">"script.npk"</span> <span class="keyword">in</span> filename:</div><div class="line">    StepUntilRet()</div><div class="line">    GetDebuggerEvent(WFNE_SUSP, <span class="number">-1</span>)</div><div class="line">    fd = cpu.r0</div><div class="line">    continue_process()</div><div class="line">    <span class="keyword">if</span> fd != idaapi.BADADDR:</div><div class="line">        print(<span class="string">"open: %s fd: %s"</span> % (filename, fd))</div><div class="line">        idc.fd_map[fd] = filename</div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line"><span class="keyword">else</span>:</div><div class="line">    print(<span class="string">"open: %s"</span> % filename)</div><div class="line">    </div><div class="line"><span class="keyword">return</span> <span class="keyword">False</span></div></pre></td></tr></table></figure>
<p>上面的代码主要是将和 <code>script.npk</code> 相关的 fd 和文件名关联起来，
方便于在 <code>read</code> 调用时区分和 <code>script.npk</code> 相关的读取操作。</p>
<p><code>read</code> 函数条件断点代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> idc</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> hasattr(idc, <span class="string">'fd_map'</span>):</div><div class="line">    <span class="keyword">return</span></div><div class="line"></div><div class="line">fd = cpu.r0</div><div class="line"></div><div class="line"><span class="keyword">if</span> fd <span class="keyword">in</span> idc.fd_map:</div><div class="line">    print(<span class="string">"reading: %s"</span> % idc.fd_map[fd])</div><div class="line">    <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">    </div><div class="line"><span class="keyword">return</span> <span class="keyword">False</span></div></pre></td></tr></table></figure>
<p>下了断点之后，你会发现这并没有什么用，因为调用次数过多，而且是由 Python 代码来负责读取解密，
如果要完整的跟完一次解密过程会特别累，既然是 Python 代码来负责读取解密，
那我们就在 <code>PyEval_EvalFrameEx</code> 处下断点来查看是什么文件在进行读取解密，添加如下代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> idc</div><div class="line"><span class="keyword">import</span> idautils</div><div class="line"></div><div class="line">f_code_addr =  idc.Dword(idautils.cpu.r0 + <span class="number">16</span>)</div><div class="line">strobj_addr = (idc.Dword(f_code_addr + <span class="number">48</span>))</div><div class="line"></div><div class="line">print(<span class="string">'eval: '</span> + idc.GetString(strobj_addr + <span class="number">20</span>))</div></pre></td></tr></table></figure>
<p>跑起来：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/redirect-show.png">
<p>这个时候我们就发现了一个可疑文件 <code>redirect.py</code>，这个 <code>redirect.py</code> 是什么时候加载的呢？
如果是从磁盘里读取的话，前面在 <code>open</code> 处的 log 会记录下来，
可是 <code>open</code> 处的 log 并没有和 <code>redirect.py</code> 相关的信息，
所以阴阳师要么用了一种比较奇怪的方式在磁盘内读取了这个文件，导致我们没有记录到，
要么就是在内部直接创建了这个 <code>redirect</code> 模块，我们先不要把情况想得太复杂，
还是先查看一下这个 <code>redirect.py</code> 模块。</p>
<h4 id="Appcall"><a href="#Appcall" class="headerlink" title="Appcall"></a>Appcall</h4><p>想要查看 <code>redirect.py</code> 模块，我们就需要 <a href="https://www.hex-rays.com/products/ida/support/tutorials/debugging_appcall.pdf" target="_blank" rel="external">IDA Appcall</a>
，<code>Appcall</code> 可以在调试的过程中，在当前程序执行环境下执行程序内、某个我们指定的函数，
所以使用 <code>Appcall</code> 调用 <code>PyRun_SimpleString</code> 我们就可以查看 Python 程序当前运行时的内部信息。</p>
<p>在这里，我们查看一下所有已经加载的 Python 模块信息：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/appcall-command-line.png">
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/appcall-get-sysmodules-1.png">
<p>信息太多了，我们只看 <code>redirect</code> 模块信息：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/appcall-get-sysmodules-2.png">
<p>发现这个 <code>redirect</code> 既不是内置模块，也不是 frozen 模块，是一个纯 Python 模块，所以我们要找到什么时候创建了这个模块。</p>
<h4 id="寻找-redirect-的创建点"><a href="#寻找-redirect-的创建点" class="headerlink" title="寻找 redirect 的创建点"></a>寻找 redirect 的创建点</h4><p>我们在 <code>PyImport_ImportModule</code>、<code>PyImport_ImportFrozenModule</code> 处下断点，继续打 log 重新跑一次：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/import-log-result.png">
<p>然而并没有 <code>import redirect</code>，这个时候我们就只能用土方法，在 <code>Py_Initialize</code> 函数执行结束之后，
通过单步跟踪以及不断的使用 <code>Appcall</code> 查看 <code>redirect</code> 模块是否被创建，
最终确定了创建 <code>redirect</code> 模块的函数 <code>sub_AD109C</code>，这个函数正在 <code>Py_Intialize</code> 调用处的下方：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/disassemble-1.png">
<p>我们再仔细看看 <code>sub_AD109C</code> 函数的实现：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/disassemble-2.png">
<p>到这里我们可以很清楚的看到创建 <code>redirect</code> 模块的过程：</p>
<ul>
<li><code>PyMarshal_ReadObjectFromString</code> 从程序某处读取 marshal 格式的字符串</li>
<li><code>PyImport_ExecCodeModule</code> 创建 <code>redirect</code> 模块</li>
</ul>
<p>原来阴阳师是直接用 marshal 格式字符串直接创建一个模块，之前我们还没意识到有 <code>PyImport_ExecCodeModule</code> 这么一个函数，
现在我们直接给 <code>PyMarshal_ReadObjectFromString</code> 下断点：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/dump-redirect-marshal-format.png">
<p>终于拿到了 <code>redirect.py</code> 的 marshal 格式字符串了。</p>
<h2 id="0x04-查看-redirect"><a href="#0x04-查看-redirect" class="headerlink" title="0x04 查看 redirect"></a>0x04 查看 redirect</h2><p>拿到了 <code>redirect</code> 模块 marshal 格式的字符串之后，添加一个 py27 的 header: <code>\x03\xf3\x0d\x0a\x00\x00\x00\x00</code>，
然后直接使用 <code>uncompyle2</code> 反编译试试看：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/redirect-uncompyle-error.png">
<p>oops，报错了，我们看一下这个 pyc 文件内部情况：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/redirect-info.png">
<p>常量表，文件名都正常，再看一下 opcode：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/redirect-dis-error.png">
<p>又报错了，我们仔细观察一下这些 opcode，会发现这些 opcode 并不是一个正常 Python 文件会产生的 opcode，
153 没有对应 opcode name，<code>EXTENDED_ARG</code> 这个 opcode 只有传递参数超过 65535 个的时候才会出现。
所以革命尚未成功，同志任需努力。</p>
<h2 id="0x05-opcode-映射关系"><a href="#0x05-opcode-映射关系" class="headerlink" title="0x05 opcode 映射关系"></a>0x05 opcode 映射关系</h2><p>看起来阴阳师好像是直接修改 Python opcode 映射关系，也就是原本 opcode 为 1 的时候代表的是 <code>POP_TOP</code>，
但是在这里被修改成 <code>ROT_THREE</code> 或者其他，想要解密 <code>redirect.pyc</code>，就必须拿到修改后的 opcode 映射关系。</p>
<p>想要拿到修改后的 opcode 映射关系，可以选择慢慢看 python 那个巨大的 switch，分析每个 opcode 对应的代码，
不过这样的方法太累人了，我们要换一种更简单的思路：</p>
<ol>
<li>使用阴阳师的 Python 来获取 一个 python script 的 pyc</li>
<li>使用正常 Python 来获取 一个 python sctipt 的 pyc</li>
<li>对比两个 pyc，拿到部分修改后的 opcode 映射关系，然后重复 1、2 两步直到 opcode 映射关系完整</li>
</ol>
<h4 id="获取-pyc"><a href="#获取-pyc" class="headerlink" title="获取 pyc"></a>获取 pyc</h4><p>想要使用阴阳师的 Python 来执行一段代码，我们就必须在 PC 上交叉编译一个程序来调用 <code>libclient.so</code> 中 Python。</p>
<p>代码如下：
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * arm-linux-androideabi-gcc test.c -o test -ldl -pie</div><div class="line"> * export LD_LIBRARY_PATH=./</div><div class="line"> * cp test /path/to/libclient.so</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</div><div class="line">    <span class="keyword">void</span> (*Py_Initialize)();</div><div class="line">    <span class="keyword">void</span> (*PyRun_SimpleString)(<span class="keyword">char</span> *);</div><div class="line">    <span class="keyword">void</span> (*Py_Finalize)();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Usage: %s script.py\n"</span>, argv[<span class="number">0</span>]);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    FILE *fp = fopen(argv[<span class="number">1</span>], <span class="string">"rb"</span>);</div><div class="line"></div><div class="line">    fseek(fp, <span class="number">0</span>, SEEK_END);</div><div class="line">    <span class="keyword">int</span> file_len = ftell(fp);</div><div class="line"></div><div class="line">    <span class="keyword">char</span> *buf = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(file_len + <span class="number">1</span>);</div><div class="line">    fseek(fp, <span class="number">0</span>, SEEK_SET);</div><div class="line">    fread(buf, file_len, <span class="number">1</span>, fp);</div><div class="line">    buf[file_len] = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">void</span> *libm_handle = dlopen(<span class="string">"libclient.so"</span>, RTLD_LAZY );</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!libm_handle)&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Open Error:%s.\n"</span>, dlerror());</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Py_Initialize = dlsym(libm_handle, <span class="string">"Py_Initialize"</span>);</div><div class="line">    Py_Initialize();</div><div class="line"></div><div class="line">    PyRun_SimpleString = dlsym(libm_handle, <span class="string">"PyRun_SimpleString"</span>);</div><div class="line">    PyRun_SimpleString(buf);</div><div class="line"></div><div class="line">    Py_Finalize = dlsym(libm_handle, <span class="string">"Py_Finalize"</span>);</div><div class="line">    Py_Finalize();</div><div class="line"></div><div class="line">    dlclose(libm_handle);</div><div class="line"></div><div class="line">    <span class="built_in">free</span>((<span class="keyword">void</span> *)buf);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将交叉编译后的程序 <code>test</code> 放到和 <code>libclient.so</code> 同一个目录下。</p>
<p>除了上面的方法外，我们还可以继续使用 <a href="https://www.hex-rays.com/products/ida/support/tutorials/debugging_appcall.pdf" target="_blank" rel="external">IDA Appcall</a>，
但是经常时灵时不灵：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/appcall-error.png">
<p>遇到这种情况，差不多只能重新开始了，所以最好还是直接使用之前交叉编译的程序。</p>
<p>现在为了更快的拿到所有 opcode 的映射关系，我直接写了一份使用了所有 <code>Python 2.7 opcode</code> 的文件：
<a href="https://gist.github.com/fate0/3e1d23bce9d4d2cfa93848dd92aba3d4" target="_blank" rel="external">py27opcode.py</a></p>
<p>因为 <code>from __future__ import division</code> 会影响 <code>division</code>，
要么一个文件的 divide 全是 true divide，要么全是正常的 divide，不能共存。</p>
<p>所以要使用阴阳师的 Python dump 两份 pyc，普通 Python dump 两份 pyc。</p>
<p>获取 pyc 脚本代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> marshal</div><div class="line"></div><div class="line">infile = <span class="string">'py27opcode.py'</span></div><div class="line">outfile = <span class="string">'android_py27opcode.pyc'</span></div><div class="line"></div><div class="line">content = open(infile).read()</div><div class="line">out_fd = open(outfile, <span class="string">'wb'</span>)</div><div class="line">cobj = compile(content, <span class="string">''</span>, <span class="string">'exec'</span>)</div><div class="line">marshal.dump(cobj, out_fd)</div><div class="line">out_fd.close()</div></pre></td></tr></table></figure>
<p>用我们在 Android 上使用之前交叉编译后的程序运行上面的代码，得到 <code>android_py27opcode.pyc</code>，
删除 division 的注释后再运行一次，得到 <code>android_py27opcode1.pyc</code>，在普通环境下，
使用没修改过的 <code>Python 2.7.3</code> 再执行相同操作，分别得到 <code>normal_py27opcode.pyc</code> 和 <code>normal_py27opcode1.pyc</code></p>
<h4 id="对比-pyc-文件"><a href="#对比-pyc-文件" class="headerlink" title="对比 pyc 文件"></a>对比 pyc 文件</h4><p>直接写代码，对比两组 pyc 的 opcode，代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> marshal</div><div class="line"></div><div class="line">opmap = &#123;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">compare</span><span class="params">(cobj1, cobj2)</span>:</span></div><div class="line">    codestr1 = bytearray(cobj1.co_code)</div><div class="line">    codestr2 = bytearray(cobj2.co_code)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> len(codestr1) != len(codestr2):</div><div class="line">        print(<span class="string">"two cobj has different length, skipping"</span>)</div><div class="line">        <span class="keyword">return</span></div><div class="line"></div><div class="line">    i = <span class="number">0</span></div><div class="line">    <span class="keyword">while</span> i &lt; len(codestr1):</div><div class="line">        <span class="keyword">if</span> codestr1[i] <span class="keyword">not</span> <span class="keyword">in</span> opmap:</div><div class="line">            opmap[codestr1[i]] = codestr2[i]</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">if</span> opmap[codestr1[i]] != codestr2[i]:</div><div class="line">                print(<span class="string">"error: has wrong opcode"</span>)</div><div class="line">                <span class="keyword">break</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> codestr1[i] &lt; <span class="number">90</span> <span class="keyword">and</span> codestr2[i] &lt; <span class="number">90</span>:</div><div class="line">            i += <span class="number">1</span></div><div class="line">        <span class="keyword">elif</span> codestr1[i] &gt;= <span class="number">90</span> <span class="keyword">and</span> codestr2[i] &gt;= <span class="number">90</span>:</div><div class="line">            i += <span class="number">3</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            print(<span class="string">"wrong opcode"</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> const1, const2 <span class="keyword">in</span> zip(cobj1.co_consts, cobj2.co_consts):</div><div class="line">        <span class="keyword">if</span> hasattr(const1, <span class="string">'co_code'</span>) <span class="keyword">and</span> hasattr(const2, <span class="string">'co_code'</span>):</div><div class="line">            compare(const1, const2)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">usage</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">"Usage: %s filename1.pyc filename2.pyc"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">if</span> len(sys.argv) != <span class="number">3</span>:</div><div class="line">        usage()</div><div class="line">        <span class="keyword">return</span></div><div class="line"></div><div class="line">    cobj1 = marshal.loads(open(sys.argv[<span class="number">1</span>]).read())</div><div class="line">    cobj2 = marshal.loads(open(sys.argv[<span class="number">2</span>]).read())</div><div class="line">    compare(cobj1, cobj2)</div><div class="line">    print(opmap)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/compare-opcode-result.png">
<p>将两组结果进行合并拿到最终的一个 opcode 映射关系。</p>
<h4 id="纠正-opcode"><a href="#纠正-opcode" class="headerlink" title="纠正 opcode"></a>纠正 opcode</h4><p>至此，我们已经有足够的信息去修正 <code>redirect.py</code> 中错位的 opcode，代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment">#! /usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> zlib</div><div class="line"><span class="keyword">import</span> rotor</div><div class="line"><span class="keyword">import</span> marshal</div><div class="line"><span class="keyword">import</span> binascii</div><div class="line"><span class="keyword">import</span> argparse</div><div class="line"><span class="keyword">import</span> pymarshal</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PYCEncryptor</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.opcode_encrypt_map = &#123;</div><div class="line">            <span class="number">1</span>: <span class="number">38</span>, <span class="number">2</span>: <span class="number">46</span>, <span class="number">3</span>: <span class="number">37</span>, <span class="number">4</span>: <span class="number">66</span>, <span class="number">5</span>: <span class="number">12</span>, <span class="number">10</span>: <span class="number">35</span>, <span class="number">11</span>: <span class="number">67</span>, <span class="number">12</span>: <span class="number">81</span>, <span class="number">13</span>: <span class="number">32</span>, <span class="number">15</span>: <span class="number">9</span>, <span class="number">19</span>: <span class="number">63</span>, <span class="number">20</span>: <span class="number">70</span>,</div><div class="line">            <span class="number">21</span>: <span class="number">44</span>, <span class="number">22</span>: <span class="number">36</span>, <span class="number">23</span>: <span class="number">39</span>, <span class="number">24</span>: <span class="number">57</span>, <span class="number">25</span>: <span class="number">10</span>, <span class="number">26</span>: <span class="number">52</span>, <span class="number">28</span>: <span class="number">49</span>, <span class="number">30</span>: <span class="number">86</span>, <span class="number">31</span>: <span class="number">87</span>, <span class="number">32</span>: <span class="number">88</span>, <span class="number">33</span>: <span class="number">89</span>,</div><div class="line">            <span class="number">40</span>: <span class="number">24</span>, <span class="number">41</span>: <span class="number">25</span>, <span class="number">42</span>: <span class="number">26</span>, <span class="number">43</span>: <span class="number">27</span>, <span class="number">50</span>: <span class="number">14</span>, <span class="number">51</span>: <span class="number">15</span>, <span class="number">52</span>: <span class="number">16</span>, <span class="number">53</span>: <span class="number">17</span>, <span class="number">54</span>: <span class="number">8</span>, <span class="number">55</span>: <span class="number">21</span>, <span class="number">56</span>: <span class="number">55</span>,</div><div class="line">            <span class="number">57</span>: <span class="number">82</span>, <span class="number">58</span>: <span class="number">34</span>, <span class="number">59</span>: <span class="number">22</span>, <span class="number">60</span>: <span class="number">65</span>, <span class="number">61</span>: <span class="number">6</span>, <span class="number">62</span>: <span class="number">58</span>, <span class="number">63</span>: <span class="number">71</span>, <span class="number">64</span>: <span class="number">43</span>, <span class="number">65</span>: <span class="number">30</span>, <span class="number">66</span>: <span class="number">19</span>, <span class="number">67</span>: <span class="number">5</span>,</div><div class="line">            <span class="number">68</span>: <span class="number">60</span>, <span class="number">71</span>: <span class="number">53</span>, <span class="number">72</span>: <span class="number">42</span>, <span class="number">73</span>: <span class="number">3</span>, <span class="number">74</span>: <span class="number">48</span>, <span class="number">75</span>: <span class="number">84</span>, <span class="number">76</span>: <span class="number">77</span>, <span class="number">77</span>: <span class="number">78</span>, <span class="number">78</span>: <span class="number">85</span>, <span class="number">79</span>: <span class="number">47</span>, <span class="number">80</span>: <span class="number">51</span>,</div><div class="line">            <span class="number">81</span>: <span class="number">54</span>, <span class="number">82</span>: <span class="number">50</span>, <span class="number">83</span>: <span class="number">83</span>, <span class="number">84</span>: <span class="number">74</span>, <span class="number">85</span>: <span class="number">64</span>, <span class="number">86</span>: <span class="number">31</span>, <span class="number">87</span>: <span class="number">72</span>, <span class="number">88</span>: <span class="number">45</span>, <span class="number">89</span>: <span class="number">33</span>, <span class="number">90</span>: <span class="number">145</span>, <span class="number">91</span>: <span class="number">159</span>,</div><div class="line">            <span class="number">92</span>: <span class="number">125</span>, <span class="number">93</span>: <span class="number">149</span>, <span class="number">94</span>: <span class="number">157</span>, <span class="number">95</span>: <span class="number">132</span>, <span class="number">96</span>: <span class="number">95</span>, <span class="number">97</span>: <span class="number">113</span>, <span class="number">98</span>: <span class="number">111</span>, <span class="number">99</span>: <span class="number">138</span>, <span class="number">100</span>: <span class="number">153</span>, <span class="number">101</span>: <span class="number">101</span>,</div><div class="line">            <span class="number">102</span>: <span class="number">135</span>, <span class="number">103</span>: <span class="number">90</span>, <span class="number">104</span>: <span class="number">99</span>, <span class="number">105</span>: <span class="number">151</span>, <span class="number">106</span>: <span class="number">96</span>, <span class="number">107</span>: <span class="number">114</span>, <span class="number">108</span>: <span class="number">134</span>, <span class="number">109</span>: <span class="number">116</span>, <span class="number">110</span>: <span class="number">156</span>,</div><div class="line">            <span class="number">111</span>: <span class="number">105</span>, <span class="number">112</span>: <span class="number">130</span>, <span class="number">113</span>: <span class="number">137</span>, <span class="number">114</span>: <span class="number">148</span>, <span class="number">115</span>: <span class="number">172</span>, <span class="number">116</span>: <span class="number">155</span>, <span class="number">119</span>: <span class="number">103</span>, <span class="number">120</span>: <span class="number">158</span>, <span class="number">121</span>: <span class="number">128</span>,</div><div class="line">            <span class="number">122</span>: <span class="number">110</span>, <span class="number">124</span>: <span class="number">97</span>, <span class="number">125</span>: <span class="number">104</span>, <span class="number">126</span>: <span class="number">118</span>, <span class="number">130</span>: <span class="number">93</span>, <span class="number">131</span>: <span class="number">131</span>, <span class="number">132</span>: <span class="number">136</span>, <span class="number">133</span>: <span class="number">115</span>, <span class="number">134</span>: <span class="number">100</span>, <span class="number">135</span>: <span class="number">120</span>,</div><div class="line">            <span class="number">136</span>: <span class="number">129</span>, <span class="number">137</span>: <span class="number">102</span>, <span class="number">140</span>: <span class="number">140</span>, <span class="number">141</span>: <span class="number">141</span>, <span class="number">142</span>: <span class="number">142</span>, <span class="number">143</span>: <span class="number">94</span>, <span class="number">146</span>: <span class="number">109</span>, <span class="number">147</span>: <span class="number">123</span></div><div class="line">        &#125;</div><div class="line">        self.opcode_decrypt_map = &#123;self.opcode_encrypt_map[key]: key <span class="keyword">for</span> key <span class="keyword">in</span> self.opcode_encrypt_map&#125;</div><div class="line">        self.pyc27_header = <span class="string">"\x03\xf3\x0d\x0a\x00\x00\x00\x00"</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_decrypt_file</span><span class="params">(self, filename)</span>:</span></div><div class="line">        os.path.splitext(filename)</div><div class="line">        content = open(filename).read()</div><div class="line"></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            m = pymarshal.loads(content)</div><div class="line">        <span class="keyword">except</span>:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                m = marshal.loads(content)</div><div class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">                print(<span class="string">"[!] error: %s"</span> % str(e))</div><div class="line">                <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line">        <span class="keyword">return</span> m.co_filename.replace(<span class="string">'\\'</span>, <span class="string">'/'</span>), pymarshal.dumps(m, self.opcode_decrypt_map)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrypt_file</span><span class="params">(self, input_file, output_file=None)</span>:</span></div><div class="line">        result = self._decrypt_file(input_file)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> result:</div><div class="line">            <span class="keyword">return</span></div><div class="line"></div><div class="line">        pyc_filename, pyc_content = result</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> output_file:</div><div class="line">            output_file = os.path.basename(pyc_filename) + <span class="string">'.pyc'</span></div><div class="line"></div><div class="line">        <span class="keyword">with</span> open(output_file, <span class="string">'wb'</span>) <span class="keyword">as</span> fd:</div><div class="line">            fd.write(self.pyc27_header + pyc_content)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    parser = argparse.ArgumentParser(description=<span class="string">'onmyoji py decrypt tool'</span>)</div><div class="line"></div><div class="line">    parser.add_argument(<span class="string">"INPUT_NAME"</span>, help=<span class="string">'input file'</span>)</div><div class="line">    parser.add_argument(<span class="string">"OUTPUT_NAME"</span>, help=<span class="string">'output file'</span>)</div><div class="line"></div><div class="line">    args = parser.parse_args()</div><div class="line"></div><div class="line">    encryptor = PYCEncryptor()</div><div class="line">    encryptor.decrypt_file(args.INPUT_NAME, args.OUTPUT_NAME)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/redirect-opcode-unmapping.png">
<h4 id="最终结果"><a href="#最终结果" class="headerlink" title="最终结果"></a>最终结果</h4><p>这次我们直接用 <code>uncompyle2</code> 反编译：</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/redirect-uncompyle-success.png">
<p>终于成功解出 <code>redirect.py</code> 文件了，根据这个 <code>redirect.py</code> 给出的信息，我们就可以拿到解密 <code>script.npk</code> 的方法：</p>
<ol>
<li>按照之前分析 <code>script.npk</code> 的方法，事先将每个加密后的 python 文件分割出来</li>
<li>按照 <code>redirect.py</code> 里面的加密方法，写出解密过程</li>
<li>按照之前方法，再修正每个 python 脚本的 opcode 映射关系</li>
</ol>
<p>至此逆向代码的工作终于完成了。</p>
<h2 id="0x05-IDAPython"><a href="#0x05-IDAPython" class="headerlink" title="0x05 IDAPython"></a>0x05 IDAPython</h2><p>记录一下在分析过程中使用的 script：</p>
<h4 id="1-尝试自动化"><a href="#1-尝试自动化" class="headerlink" title="1. 尝试自动化"></a>1. 尝试自动化</h4><p>因为要经常重开阴阳师，但是每次重新调试都需要我手动重复暂停继续等待加载 <code>libclient.so</code>，所以我写了这么一个 IDAPython Script:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">from</span> idc <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> idaapi <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> idautils <span class="keyword">import</span> *</div><div class="line"></div><div class="line">bt_cond = <span class="string">"""</span></div><div class="line">filename = GetString(cpu.r0)</div><div class="line">print("loading: %s" % filename)</div><div class="line"></div><div class="line">if not filename:</div><div class="line">    return True</div><div class="line"></div><div class="line">if filename == "libclient.so":</div><div class="line">    return True</div><div class="line">"""</div><div class="line">add_bpt(LocByName(<span class="string">'__dl__ZL17soinfo_link_imageP6soinfoPK17android_dlextinfo'</span>), <span class="number">0</span>, BPT_SOFT)</div><div class="line">enable_bpt(LocByName(<span class="string">'__dl__ZL17soinfo_link_imageP6soinfoPK17android_dlextinfo'</span>), <span class="keyword">True</span>)</div><div class="line">SetBptCnd(LocByName(<span class="string">'__dl__ZL17soinfo_link_imageP6soinfoPK17android_dlextinfo'</span>), bt_cond)</div></pre></td></tr></table></figure>
<p>看着是没什么问题，但是有时候 <code>GetString(cpu.r0)</code> 返回一个 <code>idaapi.BADADDR</code>，所以 IDA 暂停了，
但是暂停的时候去查看这个地址的内容却发现是正常数据，并不是 <code>idaapi.BADADDR</code>，这个情况我并没有去解决，后面还是老老实实手动。</p>
<h4 id="2-尝试分析函数"><a href="#2-尝试分析函数" class="headerlink" title="2. 尝试分析函数"></a>2. 尝试分析函数</h4><p>当一些断点断下来的时候，在动态调试的窗口只能看到运行指令以及之后的几条指令，虽然说也可以一直按 <code>C</code> 键，
但是总这样也挺不方便的，所以我将静态调试的 IDA 中<code>text</code> 段的函数地址全部导出到 <code>d:\\ida.txt</code> 中：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line">funclist = []</div><div class="line"><span class="keyword">for</span> seg_ea <span class="keyword">in</span> Segments():</div><div class="line">    <span class="keyword">if</span> SegName(seg_ea) != <span class="string">'.text'</span>:</div><div class="line">        <span class="keyword">continue</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> function_ea <span class="keyword">in</span> Functions(SegStart(seg_ea), SegEnd(seg_ea)):</div><div class="line">        funclist.append(function_ea)</div><div class="line"></div><div class="line">py_init = LocByName(<span class="string">'Py_Initialize'</span>)</div><div class="line">funclist.insert(<span class="number">0</span>, py_init)</div><div class="line"></div><div class="line">open(<span class="string">'d:\\ida.txt'</span>, <span class="string">'w'</span>).write(json.dumps(funclist))</div><div class="line">print(<span class="string">'done'</span>)</div></pre></td></tr></table></figure>
<p>然后再将 <code>d:\\ida.txt</code> 的内容再导入到动态调试的 IDA 中：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line">funclist = json.loads(open(<span class="string">'d:\\ida.txt'</span>).read())</div><div class="line"></div><div class="line">daynamic_py_init = LocByName(<span class="string">'Py_Initialize'</span>)</div><div class="line">static_py_init = funclist.pop(<span class="number">0</span>)</div><div class="line"></div><div class="line">offset = daynamic_py_init - static_py_init</div><div class="line"></div><div class="line"><span class="keyword">for</span> function_ea <span class="keyword">in</span> funclist:</div><div class="line">    MakeFunction(function_ea + offset)</div><div class="line"></div><div class="line">print(<span class="string">'done'</span>)</div></pre></td></tr></table></figure>
<p>然而因为 <code>libclient.so</code> 中的 <code>text</code> 段有 1w 多个函数，导入的时候 <code>MakeFunction</code> 实在太慢了，
大概要等五分钟才好，用了几次之后我就放弃了这样的方法。</p>
<h4 id="3-显示调用堆栈"><a href="#3-显示调用堆栈" class="headerlink" title="3. 显示调用堆栈"></a>3. 显示调用堆栈</h4><p>不知道为什么我的 <code>Call Stack</code> 一直显示任何东西，不确定是手机的问题还是 IDA 的问题，还是这个 App 的问题，折腾这问题感觉很麻烦。
因为 fp 寄存器还保存着程序的返回地址，所以还是直接写个 IDAPython Script 打印出调用堆栈比较方便的(如果 fp 不能用，
可以参考 <a href="http://www.hexblog.com/?p=104" target="_blank" rel="external">An attempt to reconstruct the call stack</a>)：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> idaapi, idautils</div><div class="line"></div><div class="line">static_py_init = <span class="number">0x1285398</span></div><div class="line">dynamic_py_init = LocByName(<span class="string">'Py_Initialize'</span>)</div><div class="line">offset = dynamic_py_init - static_py_init</div><div class="line"></div><div class="line">f_fp = idautils.cpu.fp</div><div class="line">f_pc = <span class="number">0</span></div><div class="line"></div><div class="line">i = <span class="number">0</span></div><div class="line"><span class="keyword">while</span> i &lt; <span class="number">100</span>:</div><div class="line">    i += <span class="number">1</span></div><div class="line">    f_pc = Dword(f_fp)</div><div class="line">    f_fp = Dword(f_fp<span class="number">-4</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> f_fp == idaapi.BADADDR:</div><div class="line">        <span class="keyword">break</span></div><div class="line"></div><div class="line">    print(<span class="string">"%s %s"</span> % (hex(f_pc), hex(f_pc - offset)))</div><div class="line"></div><div class="line">print(<span class="string">'==============================='</span>)</div></pre></td></tr></table></figure>
<h2 id="0x06-简单写个挂"><a href="#0x06-简单写个挂" class="headerlink" title="0x06 简单写个挂"></a>0x06 简单写个挂</h2><p>看了代码之后，发现抽卡的爆率不在本地，但是百鬼夜行的碎片掉率是在本地计算的，简单看一下相关代码片段：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># scenemembers/GhostWalkScene.py</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GhostWalkScene</span><span class="params">(GameScene)</span>:</span></div><div class="line">    <span class="comment"># 省略 ...</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">CheckFairGhostIsHit</span><span class="params">(self, ghostID, model)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span>  <span class="comment"># modify by fate0</span></div><div class="line">        modelIndex = self.FairModelIndexDict[model]</div><div class="line">        </div><div class="line">        <span class="comment"># 省略 ...</span></div><div class="line"></div><div class="line">        data = random.randint(<span class="number">1</span>, <span class="number">100</span>)</div><div class="line">        <span class="keyword">if</span> data &lt;= int(hitRate * <span class="number">100</span>):</div><div class="line">            <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">CheckEffectGhostIsHit</span><span class="params">(self, id)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span>  <span class="comment"># modify by fate0</span></div><div class="line">        rate = float(GhostWalkFairData.data[int(id)][<span class="string">'rate'</span>])</div><div class="line">        </div><div class="line">        <span class="comment"># 省略 ...</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> randInt &lt;= int(rate * <span class="number">100.0</span>):</div><div class="line">            <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">            </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">FireBean</span><span class="params">(self, offsetX, offsetY)</span>:</span></div><div class="line">        helpers.createModelAsync(<span class="string">'model/douzi/douzi.gim'</span>, self.FireBeanCallback, (<span class="number">0.3</span>,</div><div class="line">         offsetX,</div><div class="line">         offsetY,</div><div class="line">         self.PlayerModel))</div><div class="line">        self.TotalBeanNum = self.TotalBeanNum + <span class="number">1</span>  <span class="comment"># modify by fate0</span></div><div class="line">        </div><div class="line">        <span class="comment"># 省略 ...</span></div></pre></td></tr></table></figure>
<ul>
<li><code>CheckFairGhostIsHit</code>: 用来检查走过的式神是否被击中</li>
<li><code>CheckEffectGhostIsHit</code>: 用来检查飞过的状态是否被击中</li>
<li><code>FireBean</code>: 开火</li>
</ul>
<p>所以让 <code>CheckFairGhostIsHit</code> 和 <code>CheckEffectGhostIsHit</code> 这两个方法返回 <code>True</code> 就可以实现百分百命中，
将 <code>self.TotalBeanNum = self.TotalBeanNum - 1</code> 修改成 <code>self.TotalBeanNum = self.TotalBeanNum + 1</code> 就可以实现无限福豆。</p>
<p>视频演示：</p>
<video src="http://static.fatezero.org/blog/video/decrypt-onmyoji/demo.mp4" type="video/mp4" controls="controls" width="100%" height="100%">
</video>

<h2 id="0x07-总结"><a href="#0x07-总结" class="headerlink" title="0x07 总结"></a>0x07 总结</h2><p>第一次逆 Android 程序，感悟就是手机竟然还会有广告？</p>
<h2 id="0x08-更新"><a href="#0x08-更新" class="headerlink" title="0x08 更新"></a>0x08 更新</h2><p>找到一个对任意用户或者对任意频道用户拒绝服务的漏洞，奖励:</p>
<img src="http://static.fatezero.org/blog/img/decrypt-onmyoji/reward.png">
<iframe src="//music.163.com/outchain/player?type=2&id=588640&auto=0&height=66" width="500" height="86" frameborder="0" allowfullscreen></iframe>
</div></article></div></main><footer><div class="paginator"><a href="/2017/02/26/decrypt-rubyencoder/" class="prev">PREV</a><a href="/2016/12/21/Komm-susser-Tod/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2017 <a href="http://blog.fatezero.org">fate0</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">apollo</a>.</p></div></footer></div></body></html>